## Open eClass 2.3

Το repository αυτό περιέχει μια __παλιά και μη ασφαλή__ έκδοση του eclass.
Προορίζεται για χρήση στα πλαίσια του μαθήματος
[Προστασία & Ασφάλεια Υπολογιστικών Συστημάτων (ΥΣ13)](https://crypto.di.uoa.gr/csec/), __μην τη
χρησιμοποιήσετε για κάνενα άλλο σκοπό__.


## 2020 Project 1

Εκφώνηση: https://crypto.di.uoa.gr/csec/assets/projects/project1.pdf


### Μέλη ομάδας

- 1115201600014, Βαμβουρέλλης Ευστράτιος
- 1115201500139, Ρόκα Κωνσταντίνα

### Report

Συμπληρώστε εδώ __ένα report__ που
- Να εξηγεί τι είδους αλλαγές κάνατε στον κώδικα για να προστατέψετε το site σας (από την κάθε επίθεση).
- Να εξηγεί τι είδους επιθέσεις δοκιμάσατε στο αντίπαλο site και αν αυτές πέτυχαν.

### Αλλαγές
Προκειμένου να προστατεύσουμε το site μας από επιθέσεις, αρχικά ψάξαμε το site μέσω του UI, για να δούμε σε ποια σημεία περνάνε οι επιθέσεις μας. Έπειτα επικεντρωθήκαμε στον κώδικα του site ώστε να μην μας ξεφύγει κάτι. Στη συνέχεια ακολουθούν οι τρόποι αντιμετώπισης κάθε επίθεσης ξεχωριστά.

#### SQL INJECTION
Προκειμένου να προστατευτούμε από SQL injections, πέρα από τις δράσεις που κάναμε για τα xss (αναφέρεται παρακάτω), χρησιμοποιήσαμε prepared statements. Στο piazza του μαθήματος είδαμε αναφορά σε δύο τρόπους, pdo και mysqlnt. Δοκιμάσαμε και τα δύο για να δούμε πως δουλεύουν, αλλά στα περισσότερα σημεία χρησιμοποιήσαμε pdo prepared statements, γιατί μας βόλεψε πιο πολύ. Ψάχνοντας για τον τρόπο λειτουργίας των pdo prepared statements, είδαμε ότι δεν κάνει "πραγματικά" prepared statements by default και ότι μπορεί για αυτό το λόγο να είναι vulnerable σε συγκεκριμένες κωδικοποιήσεις. Το UTF-8 που χρησιμοποιείται στα πλαίσια της εργασίας ήταν ασφαλής κωδικοποίηση, αλλά για να είμαστε σίγουροι για την ασφάλειά μας απενεργοποιήσαμε τα emulated prepared statements. Τα prepared statements υλοποιήθηκαν για τα ερωτήματα που βρίσκονταν σε βασικά σημεία (πχ νέος χρήστης, login, αλλαγή στοιχείων κλπα).

#### XSS
Προκειμένου να προστατευτούμε από xss, ψάξαμε σε όλα τα $_GET και $_POST του κώδικα (γύρω στα 900), ώστε να μην μας ξεφύγει κάτι. Στις μεταβλητές που περνούσαν από $_GET και $_POST εφαρμόσαμε τη συνάρτηση intval όταν αφορούσαν ακεραίους (πχ id) και τη συνάρτηση my_htmlspeacialchars για τις συμβολοσειρές αντί για τις htmlspeacialchars, htmlentities. Η συνάρτηση αυτή ουσιαστικά τρέχει την htmlspecialchars με ένα έξτρα όρισμα για να την κάνει πιο ασφαλή.

#### CSRF
Οι επιλογές που είχαμε στο μυαλό μας για προστασία ενάντια στα csrf ήταν το same site cookie και το csrf token. Το same site cookie θεωρήσαμε πως δεν ήταν η σωστή επιλογή γιατί, όπως είπαμε και στις διαλέξεις, περιορίζει τη λειτουργικότητα του site. Επιλέξαμε λοιπόν να προσθέσουμε csrf token στις φόρμες σας. Επικεντρωθήκαμε κυρίως στις φόρμες του admin. Πέρα από έλεγχο για ύπαρξη του token στη φόρμα, προσθέσαμε και χρόνο διαρκείας στο token, για μεγαλύτερη ασφάλεια. Επιπλέον, κάθε φόρμα έχει διαφορετικό token από τις υπόλοιπες.

#### Remote File Inclusion
Παρατηρήσαμε ότι μπορούσαμε να δούμε όλα τα directories του project ακολουθώντας "ημιτελή" link. Επίσης, τα αρχεία που παραδίδονταν στις εργασίες αλλά και αυτά της ανταλλαγής αρχείων, αποθηκεύονταν σε subdirectories του φακέλου courses. Εφόσον μπορούσαμε να δούμε όλα τα αρχεία του site, μπορούσαμε να βρούμε που βρισκόταν το αρχείο που ανεβάζαμε και στη συνέχεια να το τρέξουμε! Προκειμένου να προστατευθούμε από επιθέσεις τέτοιου είδους, χρησιμοποιήσαμε .htaccess για να απαγορεύσουμε την πρόσβαση σε συγκεκριμένους φακέλους. Με τον ίδιο τρόπο αφαιρέθηκε και η δυνατότητα του directory listing σε όλο το site.

#### Extra προστασίες
Παρατηρήσαμε ότι κάποια αρχεία ήταν προσβάσιμα από τους απλούς χρήστες ή και τους επισκέπτες, ενώ θα έπρεπε να τα βλέπει μόνο ο admin (πχ upgrade βάσης). Για να προστατεύσουμε αυτά τα αρχεία κάνουμε έλεγχο για το αν ο χρήστης μας είναι admin. Επιπλέον, κάποιες σελίδες που ήταν ανεξάρτητες από τις 4 υποχρεωτικές λειτουργίες αφαιρέθηκαν και η είσοδος σε αυτές απαγορεύθηκε με χρήση .htacces. Οι σελίδες του admin παρέμειναν όλες ενεργές και προστατευμένες.


### Επίθεση
Το σχέδιό μας για την επίθεση ήταν να χρησιμοποιήσουμε απλές επιθέσεις για να δούμε ποια σημεία είχαν ευπάθειες και έπειτα να εξελίξουμε τις επιθέσεις μας ώστε να κάνουμε κάποια ορατή αλλαγή στο site των αντιπάλων. Αντιληφθήκαμε σε μικρό χρονικό διάστημα ότι μπορούμε να πάρουμε εύκολα δικαιώματα διαχειριστή, οπότε θα αναφερθούμε κυρίως σε ευπάθειες που εντοπίσαμε αλλά δεν εκμεταλλευθήκαμε, καθώς είχαμε ήδη πετύχει το σκοπό μας.

#### SQL Injection
Η επίθεση η οποία μας έδωσε πρόσβαση στο site ήταν το sql injection. Παρατηρήσαμε ότι οι αντίπαλοί μας δεν είχαν ασφαλίσει τη σελίδα upgrade/index.php. Στη σελίδα αυτή μπορούσαμε να εισάγουμε ως όνομα χρήστη ' OR user.user_id= '1' OR '2'='1 και ως κωδικό μια τυχαία τιμή και να συνδεθούμε με session id admin. Περιηγηθήκαμε στις υπόλοιπες σελίδες του site και κάναμε αλλαγές (πχ δημιουργία μαθήματος, επεξεργασία προφιλ), δεν ολοκληρώσαμε όμως με αυτό τον τρόπο την επίθεσή μας  καθώς, λόγω του πλάγιου τρόπου σύνδεσης, η επιλογή "Διαχείριση Πλατφόρμας" δεν εμφανιζόταν. (Δείτε το extra) Για να μπορέσουν να γίνουν αλλαγές στη σελίδα, πρέπει πριν γίνει το sql injection να έχει συνδεθεί κάποιος ως χρήστης. Αλλιώς, ενώ βλέπουμε τις φόρμες, δεν μπορούμε να τις κάνουμε submit. Ένα άλλο σημείο στο οποίο σκοπεύαμε να κάνουμε επίθεση με sql injection ήταν το search, αλλά έχει διαγραφεί η δυνατότητα αναζήτησης.

#### XSS
Δοκιμάσαμε την κλασική επίθεση με το alert στα σημεία του site που γνωρίζαμε ότι είναι ευπαθή και διαπιστώσαμε ότι μπορούμε να εγγραφούμε σαν χρήστης με στοιχεία με μορφή script. Με αυτό τον τρόπο, μπορούσαμε να ποστάρουμε πράγματα (πχ Περιοχές συζητήσεων) και όταν κάποιος έμπαινε στη σελίδα που είχε γίνει το ποστ, επειδή εμφανιζόταν το όνομά μας, εμφανιζόταν το alert. Αυτό θα μπορούσαμε να το εκμεταλλευτούμε ανακτώντας το cookie του διαχειριστή, στέλνοντας τον στην κατάλληλη σελίδα μέσω πειστικού email (πχ λίστα χρηστών, περιοχές συζητήσεων). (Παράδειγμα στο αρχείο our_txts/xss_cookie.php)

#### CSRF
Είχαμε προετοιμάσει αρκετά προσχέδια (curl) επιθέσεων CSRF, τα οποία αναφέρονται και στο αρχείο our_txts/CSRF_attacks.txt. Από αυτές δοκιμάσαμε κάποιες και δούλεψε η διαγραφή μαθήματος. Οι υπόλοιπες υπάρχουν σαν προσχέδιο αλλά δεν υλοποιήθηκαν ακριβώς, καθώς είχαμε αποκτήσει ήδη πρόσβαση στο site. Οι υλοποιημένες επιθέσεις βρίσκονται στο puppies στα αρχεία index*.php. Δεν στάλθηκαν δύο ήδη υλοποιημένες επιθέσεις που αφορούσαν το config καθώς δεν είχαμε δικαιώματα αλλαγής (chmod). Επιχειρήσαμε να εγγράψουμε καθηγητή (είχε διαγραφεί η δυνατότητα), να επεξεργαστούμε το προφίλ του διαχειριστή (προστατευμένο), δημιουργία μαθήματος (προστατευμένο), δημιουργία ανακοίνωσης διαχειριστής, διαγραφή μαθήματος (επιτυχημένο).  

#### Remote file inclusion
Είχαμε παρατηρήσει ότι στο αρχικό site, μπορούσες να ανεβάσεις ένα αρχείο (εργασία, ανταλλαγή αρχείων), το οποίο αποθηκευόταν με τυχαίο/hashed όνομα. Στη συνέχεια, μπορούσαμε να κάνουμε directory listing και να τρέξουμε το αρχείο μας μέσω του γνωστού πλέον, path του. Οι αντίπαλοί μας είχαν αφαιρέσει τη δυνατότητα του directory listing. Παρατηρήσαμε όμως ότι, αν βάλεις στο link μη υπάρχον id (>1), δημιουργείται αρχείο στο courses/TMA103/work/id_value/Ονομα Επωνυμο.κατάληξη_αρχείου. Δοκιμάσαμε να βάλουμε id = ../1 για να ανεβάσουμε το αρχείο μας σε προηγούμενο directory αλλά δεν δούλεψε (υποθέτουμε λόγω intval), οπότε περιοριστήκαμε στα αριθμητικά id. Στο site των αντιπάλων απαγορευόταν να ανεβάσεις αρχεία που περιέχουν την λέξη php (πχ "Μου αρέσει η php"), κάτι που δεν αναφερόταν ρητά σε κάποιο σημείο. Επομένως, ενώ μπορούμε να τρέξουμε το αρχείο που ανεβάσαμε (πχ html), δεν μπορούμε να κάνουμε σοβαρές αλλαγές στο site. Προσπαθώντας να παρακάμψουμε τον περιορισμό αυτό, καταφέραμε να ανεβάσουμε αρχείο με περιεχόμενο php σε διαφορετική κωδικοποίηση (utf16). Τότε παρατηρήσαμε ότι οι αντίπαλοι αλλάξουν την κατάληξη .php σε .txt. Για να παρακάμψουμε την μετατροπή αυτή, δοκιμάσαμε να φτιάξουμε χρήστη με όνομα κάτι.php και κενό επώνυμο (" ") και να ανεβάσουμε αρχείο χωρίς κάποια κατάληξη, αλλά δεν καταφέραμε να βρούμε το όνομα του αρχείου στο server. Αντίστοιχες δοκιμές κάναμε και για να δημιουργήσουμε αρχεία με όνομα .htaccess, αλλά δεν τα καταφέραμε. Τέλος, τα αρχεία html που ανεβαίνουν στην ανταλλαγή αρχείων, τρέχουν (αντί να κατεβαίνουν) απλά πατώντας το αρχείο.

#### Extra
Όπως αναφέρθηκε και στο κομμάτι για τα SQL Injections, ο τρόπος με τον οποίο είχαμε καταφέρει να συνδεθούμε ως admin, δεν μας επέτρεπε να επιλέξουμε το "Διαχείριση Πλατφόρμας". Για αυτό το λόγο δοκιμάσαμε να μπούμε στις σελίδες του admin γράφοντας κατευθείαν το path στο browser (/modules/admin/). Τα paths αυτά οδηγούσαν σε 404 not found και μετά από δοκιμές, καταλήξαμε στο συμπέρασμα ότι το όνομα του directory του admin έχει τροποποιηθεί. Ακολουθώντας λοιπόν την διαδικασία που περιγράφεται παρακάτω (Δείτε Ανάκτηση αρχείων), φροντίσαμε να ανακτήσουμε το όνομα του directory στο οποίο ήταν τοποθετημένες οι σελίδες του admin.

#### Defacement
Το αρχικό μας πλάνο για το defacement ήταν να ανεβάσουμε ανακοίνωση διαχειριστή με script. Όταν είδαμε ότι δεν γνωρίζουμε το όνομα του directory του admin, αρχίσαμε να ψάχνουμε άλλους τρόπους για να κάνουμε defacement, ανεβάζοντας αρχείο php. Βρήκαμε τους εξής τρόπους:
* Ανεβάσαμε αρχείο .php με κώδικα php στην ανταλλαγή αρχείων. Στη συνέχεια, κατεβάσαμε το αντίγραφο ασφαλείας (από τη διαχείριση μαθήματος). Στους φακέλους του αντιγράφου φαίνεται το κωδικοποιημένο όνομα του αρχείου που ανεβάσαμε στην ανταλλαγή αρχείων. Επομένως, αφού βρήκαμε το όνομα, μπορέσαμε να τρέξουμε το αρχείο μας.
* Παρατηρήσαμε ότι στο ανέβασμα ιστοσελίδας των εργαλείων του μαθήματος, επιτρεπόταν ανέβασμα html αρχείων αποκλειστικά. Μπορέσαμε όμως να παρακάμψουμε τον περιορισμό αυτό (μέσω του inspect), καθώς ο έλεγχος γινόταν με html (client side).

Με αυτούς τους τρόπους ανεβάσαμε και τρέξαμε αρχείο php στο server, άρα είχαμε περισσότερα δικαιώματα και από τον admin.
Στη συνέχεια, είδαμε τον κωδικό της βάσης στο περιεχόμενο του config, ο οποίος ήταν διαφορετικός από τον κωδικό του admin (εκτέλεση αρχείου steal_conf.php που βρίσκεται στο /our_txts).
Τέλος, κάναμε defacement χρησιμοποιώντας το αρχείο deface.php (/our_txts).

### Αποτελέσματα
**Κωδικός βάσης:** C27PRnhyVjYL5Efb
**Hash κωδικού admin:** cb17986e03d289c35abe1f212d0e25d8   
**Σελίδα defacement:** hack-n-roll.csec.chatzi.org/index2.html  
**Κρυφό defacement:** http://hack-n-roll.csec.chatzi.org/modules/conference/refresh_chat.php?fbclid=IwAR02TVNtgpPwujTLtrf0eiUWTVF1IzNED0Nx1QDQ97rkJKSb-DtAiprnFEk   
**Directory admin:** /modules/coach/   
