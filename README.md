## Open eClass 2.3

Το repository αυτό περιέχει μια __παλιά και μη ασφαλή__ έκδοση του eclass.
Προορίζεται για χρήση στα πλαίσια του μαθήματος
[Προστασία & Ασφάλεια Υπολογιστικών Συστημάτων (ΥΣ13)](https://crypto.di.uoa.gr/csec/), __μην τη
χρησιμοποιήσετε για κάνενα άλλο σκοπό__.


## 2020 Project 1

Εκφώνηση: https://crypto.di.uoa.gr/csec/assets/projects/project1.pdf


### Μέλη ομάδας

- 1115201600014, Βαμβουρέλλης Ευστράτιος
- 1115201500139, Ρόκα Κωνσταντίνα

### Report

Συμπληρώστε εδώ __ένα report__ που
- Να εξηγεί τι είδους αλλαγές κάνατε στον κώδικα για να προστατέψετε το site σας (από την κάθε επίθεση).
- Να εξηγεί τι είδους επιθέσεις δοκιμάσατε στο αντίπαλο site και αν αυτές πέτυχαν.

### Αλλαγές
Προκειμένου να προστατεύσουμε το site μας από επιθέσεις, αρχικά ψάξαμε το site μέσω του UI, για να δούμε σε ποια σημεία περνάνε οι επιθέσεις μας. Έπειτα επικεντρωθήκαμε στον κώδικα του site ώστε να μην μας ξεφύγει κάτι. Στη συνέχεια ακολουθούν οι τρόποι αντιμετώπισης κάθε επίθεσης ξεχωριστά.

#### SQL INJECTION
Προκειμένου να προστατευτούμε από SQL injections, πέρα από τις δράσεις που κάναμε για τα xss (αναφέρεται παρακάτω), χρησιμοποιήσαμε prepared statements. Στο piazza του μαθήματος είδαμε αναφορά σε δύο τρόπους, pdo και mysqlnt. Δοκιμάσαμε και τα δύο για να δούμε πως δουλεύουν, αλλά στα περισσότερα σημεία χρησιμοποιήσαμε pdo prepared statements, γιατί μας βόλεψε πιο πολύ. Ψάχνοντας για τον τρόπο λειτουργίας των pdo prepared statements, είδαμε ότι δεν κάνει "πραγματικά" prepared statements by default και ότι μπορεί για αυτό το λόγο να είναι vulnerable σε συγκεκριμένες κωδικοποιήσεις. Το UTF-8 που χρησιμοποιείται στα πλαίσια της εργασίας ήταν ασφαλής κωδικοποίηση, αλλά για να είμαστε σίγουροι για την ασφάλειά μας απενεργοποιήσαμε τα emulated prepared statements. Τα prepared statements υλοποιήθηκαν για τα ερωτήματα που βρίσκονταν σε βασικά σημεία (πχ νέος χρήστης, login, αλλαγή στοιχείων κλπα).

#### XSS
Προκειμένου να προστατευτούμε από xss, ψάξαμε σε όλα τα $_GET και $_POST του κώδικα (γύρω στα 900), ώστε να μην μας ξεφύγει κάτι. Στις μεταβλητές που περνούσαν από $_GET και $_POST εφαρμόσαμε τη συνάρτηση intval όταν αφορούσαν ακεραίους (πχ id) και τη συνάρτηση my_htmlspeacialchars για τις συμβολοσειρές αντί για τις htmlspeacialchars, htmlentities. Η συνάρτηση αυτή ουσιαστικά τρέχει την htmlspecialchars με ένα έξτρα όρισμα για να την κάνει πιο ασφαλή.

#### CSRF
Οι επιλογές που είχαμε στο μυαλό μας για προστασία ενάντια στα csrf ήταν το same site cookie και το csrf token. Το same site cookie θεωρήσαμε πως δεν ήταν η σωστή επιλογή γιατί, όπως είπαμε και στις διαλέξεις, περιορίζει τη λειτουργικότητα του site. Επιλέξαμε λοιπόν να προσθέσουμε csrf token στις φόρμες σας. Επικεντρωθήκαμε κυρίως στις φόρμες του admin. Πέρα από έλεγχο για ύπαρξη του token στη φόρμα, προσθέσαμε και χρόνο διαρκείας στο token, για μεγαλύτερη ασφάλεια. Επιπλέον, κάθε φόρμα έχει διαφορετικό token από τις υπόλοιπες.

#### Remote File Inclusion
Παρατηρήσαμε ότι μπορούσαμε να δούμε όλα τα directories του project ακολουθώντας "ημιτελή" link. Επίσης, τα αρχεία που παραδίδονταν στις εργασίες αλλά και αυτά της ανταλλαγής αρχείων, αποθηκεύονταν σε subdirectories του φακέλου courses. Εφόσον μπορούσαμε να δούμε όλα τα αρχεία του site, μπορούσαμε να βρούμε που βρισκόταν το αρχείο που ανεβάζαμε και στη συνέχεια να το τρέξουμε! Προκειμένου να προστατευθούμε από επιθέσεις τέτοιου είδους, χρησιμοποιήσαμε .htaccess για να απαγορεύσουμε την πρόσβαση σε συγκεκριμένους φακέλους. Με τον ίδιο τρόπο αφαιρέθηκε και η δυνατότητα του directory listing σε όλο το site.

#### Extra προστασίες
Παρατηρήσαμε ότι κάποια αρχεία ήταν προσβάσιμα από τους απλούς χρήστες ή και τους επισκέπτες, ενώ θα έπρεπε να τα βλέπει μόνο ο admin (πχ upgrade βάσης). Για να προστατεύσουμε αυτά τα αρχεία κάνουμε έλεγχο για το αν ο χρήστης μας είναι admin. Επιπλέον, κάποιες σελίδες που ήταν ανεξάρτητες από τις 4 υποχρεωτικές λειτουργίες αφαιρέθηκαν και η είσοδος σε αυτές απαγορεύθηκε με χρήση .htacces. Οι σελίδες του admin παρέμειναν όλες ενεργές και προστατευμένες.


### Επίθεση
Το σχέδιό μας για την επίθεση ήταν να χρησιμοποιήσουμε απλές επιθέσεις για να δούμε ποια σημεία είχαν ευπάθειες και έπειτα να εξελίξουμε τις επιθέσεις μας ώστε να έχουν κάποια ορατή αλλαγή στο site των αντιπάλων. Αντιληφθήκαμε σε μικρό χρονικό διάστημα ότι μπορούμε να πάρουμε εύκολα δικαιώματα διαχειριστή, οπότε θα αναφερθούμε κυρίως σε ευπάθειες που εντοπίσαμε αλλά δεν εκμεταλλευθήκαμε γιατ είχαμε πετύχει ήδη το σκοπό μας. (Δείτε το extra)

#### SQL Injection
Η επίθεση η οποία μας έδωσε πρόσβαση στο site ήταν το sql injection. Παρατηρήσαμε ότι οι αντίπαλοί μας δεν είχαν ασφαλίσει τη σελίδα upgrade/index.php. Στη σελίδα αυτή μπορούσαμε να δώσουμε ως όνομα χρήστη ' OR user.user_id= '1' OR '2'='1 και να συνδεθούμε με id admin. Η σελίδα στην οποία οδηγούμασταν άλλαζε πράγματα στο config, το οποίο δεν είχαμε δικαίωμα να αλλάξουμε, αλλά μπορούσαμε να πάμε σε κάποια άλλη σελίδα και να τροποποιήσουμε πράγματα από εκεί. Δεν ολοκληρώσαμε όμως με αυτό τον τρόπο την επίθεσή μας, καθώς λόγω του πλάγιου τρόπου σύνδεσης, η επιλογή "Διαχείριση Πλατφόρμας" δεν εμφανιζόταν.

#### XSS
Δοκιμάσαμε την κλασσική επίθεση με το alert στα σημεία του site που γνωρίζαμε ότι είναι ευπαθή και διαπιστώσαμε ότι μπορούμε να εγγραφούμε σαν χρήστης script. Με αυτό τον τρόπο, μπορούσαμε να ποστάρουμε πράγματα (πχ συζητήσεις) και όταν κάποιος έμπαινε στη σελίδα που είχε γίνει το ποστ, επειδή εμφανιζόταν το όνομά μας, εμφανιζόταν το alert.

#### CSRF
Είχαμε προετοιμάσει αρκετές επιθέσεις CSRF, οι οποίες αναφέρονται και στο αρχείο our_txts/CSRF_attacks.txt. Από αυτές δοκιμάσαμε κάποιες και δούλεψε η διαγραφή μαθήματος. Οι υπόλοιπες υπάρχουν σαν προσχέδιο αλλά δεν υλοποιήθηκαν ακριβώς καθώς είχαμε αποκτήσει ήδη πρόσβαση στο site.

#### Remote file inclusion
Είχαμε παρατηρήσει ότι στο αρχικό site, μπορούσες να ανεβάσεις μια εργασία ή ένα αρχείο (ανταλλαγή αρχείων) και γράφοντας το path του να το τρέξεις. Επειδή οι αντίπαλοί μας είχαν αφαιρέσει τη δυνατότητα του directory listing, μπορούσαμε να δοκιμάσουμε να τρέξουμε μόνο το αρχείο που είχαμε παραδώσει σαν εργασία, καθώς το path του ήταν πολύ πιο εύκολα προβλέψιμο απ' ότι αυτό του αρχείου της ανταλλαγής αρχείων. Οι αντίπαλοι όμως, είχαν φροντίσει να αφαιρέσουν τη δυνατότητα να ανεβαίνουν αρχεία τα οποία περιέχουν την λέξη php (περιεχόμενο, όχι στο όνομα). Η ιδιαιτερότητα αυτή ήταν συμπέρασμα δικής μας παρατήρησης και δεν αναφερόταν ρητά σε κάποιο σημείο.

#### Extra
Όπως αναφέρθηκε και στο κομμάτι για τα SQL Injections, ο τρόπος με τον οποίο είχαμε καταφέρει να συνδεθούμε δεν μας επέτρεπε να επιλέξουμε το "Διαχείριση Πλατφόρμας". Για αυτό το λόγο δοκιμάσαμε να μπούμε στις σελίδες του admin γράφοντας κατευθείαν το path στο browser. Τα paths αυτά οδηγούσαν σε 404 not found και προβληματιστήκαμε για το αν έχουμε συνδεθεί όντως ως διαχειριστές. Αφού σιγουρέψαμε λοιπόν ότι μπορούσαμε να εκτελέσουμε λειτουργίες διαχειριστή (προσθέσαμε μάθημα, αλλάξαμε τα στοιχεία του διαχειριστή), καταλήξαμε στο συμπέρασμα ότι τα ονόματα των directories έχουν τροποποιηθεί. Ακολουθώντας λοιπόν την διαδικασία που περιγράφεται παρακάτω (Δείτε Ανάκτηση αρχείων), φροντίσαμε να ανακτήσουμε το όνομα του directory στο οποίο ήταν τοποθετημένες οι σελίδες του admin, ώστε να μπορέσουμε στη συνέχεια να στείλουμε τις csrf επιθέσεις μας στις συγκεκριμένες σελίδες.

#### Ανάκτηση Αρχείων
Όταν είδαμε ότι δεν έχουμε πρόσβαση στις λειτουργίες του admin, αρχίσαμε να ψάχνουμε για τρόπους να βρούμε το όνομα του directory στο οποίο είχαν τοποθετηθεί οι σελίδες.
Αφού αποκτήσαμε πρόσβαση σε αυτά λοιπόν, είδαμε τον κωδικό της βάσης στο περιεχόμενο του config (διαφορετικός από τον κωδικό του admin), προσθέσαμε τη σελίδα του defacement και κάναμε τα CSRF attacks μας. 

### Αποτελέσματα
**Κωδικός βάσης:** C27PRnhyVjYL5Efb
**Hash κωδικού admin:** cb17986e03d289c35abe1f212d0e25d8
**Σελίδα defacement:** hack-n-roll.csec.chatzi.org/index2.html 
